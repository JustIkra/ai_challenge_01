# TASK-006: PR Review через RAG + Git diff/files (slash-команда)

## Статус: `done`

## Цель

Добавить в проект slash-команду, которая делает **автоматическое ревью Pull Request**:
- использует **RAG** по документации и коду проекта как контекст (README, docs, правила стиля, архитектура),
- получает **diff и изменённые файлы PR** через MCP (без ручного копипаста),
- выдаёт **текст ревью с замечаниями** (actionable, с источниками).

## Пользовательская история

Как разработчик, я хочу запустить `/pr:review ...` и получить структурированный review (найденные проблемы, рекомендации, вопросы, риски), основанный на diff + документации/кодовой базе проекта.

## Предлагаемый интерфейс команды

### Slash-команда

Файл: `.claude/commands/pr/review.md`

Варианты запуска:
- `/pr:review <base_ref> <head_ref>` — review изменений из `base_ref...head_ref` (PR-диапазон)
- `/pr:review` — по умолчанию `base_ref=main`, `head_ref=HEAD` (текущая ветка)

Опциональные флаги (MVP можно без них):
- `--k <n>` — сколько результатов RAG брать (default: 10)
- `--threshold <0..1>` — порог релевантности RAG (default: 0.70)
- `--files <n>` — ограничение по числу анализируемых файлов
- `--max-diff-bytes <n>` — защитный лимит размера diff
- `--debug` — вывести, какие источники/сигналы использованы

## MCP: получение diff и файлов PR

Вариант 1 (рекомендовано): **использовать “official git MCP server”**, если он уже доступен/легко подключается.

Нужно, чтобы он умел (в терминах git):
- получить список изменённых файлов в диапазоне: `git diff --name-status <base>...<head>`
- получить unified diff в диапазоне: `git diff <base>...<head>`
- прочитать файл на конкретном ref: `git show <ref>:<path>`

Если “official git MCP” покрывает эти операции (инструменты типа `diff`, `status`, `show`/`cat`, `log`), то **кастомный сервер не нужен** — slash-команда `/pr:review` просто вызывает готовые MCP tools.

Вариант 2 (fallback): добавить свой MCP server (например, `mcp/git-pr/`) с allowlist git-команд (только чтение):
- `pr_meta(baseRef, headRef)` → merge-base sha, head sha, branch names
- `pr_files(baseRef, headRef)` → список изменённых файлов (name-status)
- `pr_diff(baseRef, headRef, options)` → unified diff (с лимитами по размеру/кол-ву хунков)
- `pr_file(ref, path)` → содержимое файла на конкретном ref (для точного контекста PR)

В обоих вариантах зарегистрировать MCP сервер в `.mcp.json`.

Важно: PR в рамках локального git моделируется как диапазон `base...head` (трёхточечный diff через merge-base).

## RAG: контекст из документации и кода

MVP:
- перед генерацией review вызвать `rag_search` (format json) по запросу, составленному из:
  - “PR review” + список изменённых файлов + ключевые строки из diff (заголовки хунков),
  - общие запросы по правилам стиля и архитектуре (`CLAUDE.md`, линтеры/форматтеры, структуры сервисов).
- использовать результаты RAG как “policy/context”, но **не подменять** ими содержимое PR (PR содержимое берётся из MCP `pr_diff`/`pr_file`).

## Формат результата (review)

Команда должна печатать review в markdown с понятной структурой:

- `Summary` (1–3 предложения: что меняется и какой риск)
- `Major issues` (ломает, безопасность, данные, API, миграции)
- `Minor issues` (стиль, читаемость, DX)
- `Questions` (что уточнить у автора)
- `Suggested test plan` (как проверить)
- `Sources` (список использованных файлов/доков и ссылки на дифф/пути)

Требования к качеству:
- замечания должны быть **привязаны к конкретным файлам/хункам** (файл + контекст diff; для файлов — line numbers где возможно),
- запрещено галлюцинировать: если данных нет — явно писать “не найдено / не видно в diff”.

## Test case (репо + “PR”)

Цель теста: воспроизвести review на реальном диапазоне веток в этом репозитории.

### Набор данных

Ветка `day-20` может совпадать с `main` (diff пустой). Для стабильного кейса используем ветку с реальными отличиями:
- `base_ref = main`
- `head_ref = day-19`

Проверка, что есть diff:
```bash
git diff --name-only main...day-19 | head
```

### Прогон

1) Убедиться, что RAG индекс не пустой:
- `/rag:status` (если 0 документов → `/rag:index`)

2) Запустить review:
- `/pr:review main day-19`

### Ожидаемое поведение (критерии)

- Review содержит минимум 5 замечаний/вопросов, и минимум 3 из них ссылаются на конкретные файлы из diff (`pr_files`).
- Review включает “Suggested test plan” и учитывает компоненты (backend/frontend/migrations), если они затронуты.
- “Sources” содержит:
  - список изменённых файлов PR,
  - минимум 2 источника из RAG (например `README.md`, `CLAUDE.md`, `docs/` или `.memory-base/technical-docs/`).

## Deliverables

1) `mcp/git-pr/` (или аналог) + регистрация в `.mcp.json`
2) `.claude/commands/pr/review.md` (slash-команда `/pr:review`)
3) Обновление `README.md` или `docs/` с кратким примером использования
4) (Опционально) `docs/plans/...` с дизайном пайплайна PR-review (если нужно зафиксировать формат/порог/лимиты)

## Acceptance Criteria

- [x] `/pr:review` работает без ручного копипаста diff
- [x] Diff и файлы PR получаются через MCP tools (GitHub MCP: `search_pull_requests`, `pull_request_read`)
- [x] RAG используется для документации/правил проекта, а не как единственный источник изменений
- [x] Review структурирован и содержит привязку к файлам/хункам
- [x] Есть воспроизводимый тест-кейс на `main...day-19`

## Implementation Notes

**Решение:** Использован GitHub MCP вместо кастомного `mcp/git-pr/` сервера.

**Причина:** GitHub MCP уже доступен и предоставляет все необходимые инструменты:
- `search_pull_requests` — поиск PR по веткам
- `pull_request_read(method: get_files)` — список файлов
- `pull_request_read(method: get_diff)` — unified diff

**Ограничение:** PR должен существовать на GitHub (не работает с чисто локальными ветками).

**Созданные файлы:**
- `.claude/commands/pr/review.md` — slash-команда
- `docs/plans/2026-01-13-pr-review-design.md` — дизайн-документ
- `README.md` — обновлена секция Claude Code Commands

## Приоритет: `high`
