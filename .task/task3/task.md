# Сжатие истории диалога

**Status: DONE**

## Цель

Реализовать механизм сжатия истории диалога, чтобы длинные чаты не приводили к избыточному расходу токенов и деградации качества ответов, за счёт автоматического суммирования части сообщений и замены их компактными summary.

## Что нужно изменить

- Backend (например, `backend/app/services/chat.py`, модели и схемы):
  - Добавить структуру/модель для хранения «сжатых» блоков истории (summary) вместе с метаданными (диапазон сообщений, время, автор).
  - Реализовать механизм, который после достижения порога (например, каждые N сообщений, по умолчанию 10) собирает исходные сообщения, строит их summary и помечает исходные сообщения как «сжатые» или заменяет их одним summary‑блоком.
  - Обеспечить, чтобы при формировании prompt для модели использовались уже сжатые блоки истории вместо исходных сообщений, с учётом лимитов контекста.
- Gemini/worker‑слой:
  - Определить, кто отвечает за построение summary: backend или worker, выполняющий запрос к модели.
  - Добавить вызов модели для генерации краткого summary по группе сообщений (с устойчивым system prompt, который объясняет, как именно сжимать историю).
- Frontend — UI и настройки:
  - Добавить в UI (например, в настройки чата или глобальные настройки) переключатель/контрол «Сжатие истории» с возможностью включения/выключения механизма.
  - Добавить настройку порога сжатия (N сообщений до summary) с безопасным диапазоном значений и разумным значением по умолчанию (например, 10).
  - Обеспечить сохранение этих настроек на уровне чата или пользователя и передачу их в backend при изменении.
- Модель данных / схемы:
  - Расширить схемы чата/настроек, чтобы хранить выбранные параметры сжатия (включено/выключено, порог, стратегия).
  - При необходимости добавить отдельную сущность или поле для хранения summary‑блоков.

## Критерии приёмки

- [x] В UI чата/настроек появляется настройка включения/выключения сжатия истории, а также параметр порога (N сообщений).
- [x] При достижении порога сообщений (по умолчанию 10) система строит summary по этим сообщениям и далее использует summary вместо исходных сообщений при формировании prompt для модели.
- [x] Сжатие истории работает прозрачно для пользователя: в UI история отображается корректно (отдельно обсудить, как показывать «сжатые» блоки).
- [x] Настройки сжатия сохраняются и применяются при последующих запросах, в том числе после перезагрузки страницы/рестарта сервисов.
- [x] Все существующие тесты проходят (проверка в Docker), для новой логики добавлены базовые авто‑тесты.

## Реализация

### Изменённые/созданные файлы

**Backend:**
- `backend/app/models/chat.py` — добавлено поле `compressed_history_summary`
- `backend/app/models/message.py` — добавлено поле `is_compressed`
- `backend/app/schemas/chat.py` — добавлены поля сжатия в ChatCreate, ChatUpdate, ChatResponse
- `backend/app/schemas/message.py` — добавлено поле `is_compressed` в MessageResponse
- `backend/app/schemas/rabbitmq.py` — добавлено поле `metadata` для маркировки compression-запросов
- `backend/app/services/compression.py` — **новый** сервис логики сжатия
- `backend/app/services/chat.py` — обновлён `send_message_to_gemini()` для использования summary
- `backend/app/workers/response_consumer.py` — добавлен триггер сжатия после ответа
- `backend/alembic/versions/005_add_compression_fields.py` — миграция БД
- `backend/tests/test_compression.py` — **новый** 24 unit-теста

**Frontend:**
- `frontend/src/types/chat.ts` — добавлены типы для compression
- `frontend/src/components/chat/ChatSettingsModal.vue` — UI настроек сжатия
- `frontend/src/components/chat/ChatWindow.vue` — сворачивание сжатых сообщений

### Архитектура решения

1. Пользователь включает сжатие в настройках чата (toggle + slider 5-50 сообщений)
2. После достижения порога несжатых сообщений `ResponseConsumer` запускает compression request
3. Gemini генерирует summary по системному промпту
4. Summary сохраняется в `chat.compressed_history_summary`, сообщения помечаются `is_compressed=True`
5. При формировании prompt для AI: сначала summary, потом только несжатые сообщения
6. В UI сжатые сообщения показываются свёрнутыми с возможностью развернуть

