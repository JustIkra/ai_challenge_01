# Support Bot

Telegram бот для ответов на вопросы пользователей с использованием RAG (Retrieval-Augmented Generation).

## Как работает

1. Пользователь отправляет вопрос боту в личные сообщения
2. Бот ищет релевантный контекст через RAG-сервер
3. Контекст передаётся в LLM (OpenRouter) вместе с вопросом
4. LLM формирует ответ с указанием источников

## Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Приветствие и справка |
| `/questions` | Примеры вопросов |

## Конфигурация

Переменные окружения:

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `TELEGRAM_BOT_TOKEN` | Токен бота от @BotFather | **обязательно** |
| `RAG_SERVER_URL` | URL RAG-сервера | `http://rag-server:8801` |
| `RAG_TOP_K` | Кол-во результатов поиска | `5` |
| `OPENROUTER_API_KEYS` | API ключи OpenRouter (через запятую) | **обязательно** |
| `OPENROUTER_BASE_URL` | Base URL OpenRouter | `https://openrouter.ai/api/v1` |
| `OPENROUTER_MODEL` | Модель для генерации | `anthropic/claude-3-haiku` |
| `MAX_INPUT_LENGTH` | Макс. длина вопроса | `1000` |
| `MAX_OUTPUT_LENGTH` | Макс. длина ответа | `4000` |

## Запуск

### Docker Compose (рекомендуется)

```bash
# Из корня проекта
docker-compose up -d support-bot
```

### Локально (для разработки)

```bash
cd support-bot

# Установка зависимостей
pip install -r requirements.txt

# Запуск
python -m src.main
```

## Зависимости

- Python 3.11+
- aiogram 3.x
- aiohttp
- python-dotenv

## Интеграция с RAG-сервером

Бот вызывает RAG-сервер по HTTP:

```
POST http://rag-server:8801/api/search
{
  "query": "текст вопроса",
  "limit": 5
}
```

Для работы необходимо, чтобы RAG-сервер был запущен и индекс был заполнен:

```bash
# Проверить статус индекса
curl http://localhost:8801/api/status

# Если индекс пуст, запустить индексацию через Claude Code:
# /rag:index
```

## Формат ответа

```
[Ответ от LLM]

Источники:
- auth.md
- api-reference.md
```

## Edge Cases

| Сценарий | Поведение |
|----------|-----------|
| Пустое сообщение | Игнорируется |
| Стикер/фото/голосовое | Игнорируется |
| Сообщение в группе | Игнорируется |
| Сообщение > 1000 символов | Обрезается |
| RAG не нашёл результатов | LLM отвечает без источников |
| Ошибка OpenRouter | "Произошла ошибка, попробуйте позже" |
| Ответ > 4096 символов | Обрезается до 4000 |
