# План имплементации: День 8 — Работа с токенами

## Обзор

Необходимо добавить подсчёт количества токенов для запросов к модели и ответов от неё, интегрировав это в текущий поток обработки сообщений (backend → очередь → gemini-client → ответ).

## Принятые решения (черновик)

| # | Вопрос | Решение (предварительно) |
|---|--------|--------------------------|
| Q1 | Где считать токены? | В gemini-client, максимально близко к вызову API |
| Q2 | Какие токены считаем? | Отдельно для prompt (запроса) и completion (ответа) |
| Q3 | Как сохраняем результат? | Минимум — логирование; опционально — сохранение в БД |
| Q4 | Как отображаем? | На первом этапе только в логах |
| Q5 | Как тестируем? | Юнит‑тесты на функцию подсчёта и интеграционный тест на общий поток |

## Шаги имплементации

1. Проанализировать текущий поток отправки запросов к Gemini:
   - Где формируется `GeminiRequestMessage`;
   - Где получается ответ и где сейчас есть логирование.
2. Выбрать способ подсчёта токенов:
   - Использовать доступные средства SDK/клиента Gemini, если они есть;
   - Либо добавить локальную функцию/утилиту для оценки токенов.
3. Добавить утилиту подсчёта токенов в gemini-client:
   - Функция, принимающая текст и параметры модели, возвращающая количество токенов.
4. Интегрировать подсчёт токенов в процесс обработки:
   - При подготовке запроса к модели вычислять токены prompt и логировать/сохранять их;
   - После получения ответа вычислять токены completion и логировать/сохранять их.
5. При необходимости расширить схемы/модели backend:
   - Добавить поля для токенов (prompt_tokens, completion_tokens, total_tokens) в DTO/схемы;
   - Обеспечить передачу этих данных от/к gemini-client, если решено хранить их в БД.
6. Добавить логирование:
   - В логах gemini-client выводить request_id, модель, количество токенов по типам и время обработки;
   - При необходимости добавить structured logging (JSON) для дальнейшей аналитики.
7. Добавить тесты:
   - Юнит‑тесты на функцию подсчёта токенов;
   - Интеграционный тест, проверяющий, что при обработке сообщения токены рассчитываются и логируются.

## Порядок выполнения

1. [ ] Анализ текущего потока запросов/ответов и мест логирования.
2. [ ] Выбор и реализация функции подсчёта токенов.
3. [ ] Интеграция подсчёта токенов в gemini-client.
4. [ ] (Опционально) Расширение схем/моделей backend для хранения токенов.
5. [ ] Добавление логирования токенов.
6. [ ] Написание и запуск тестов.
7. [ ] Финальная проверка в Docker‑окружении.

