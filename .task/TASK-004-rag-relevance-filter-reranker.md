# TASK-004: RAG — второй этап после поиска (фильтр релевантности / reranker)

## Статус: `done`

## Описание

Улучшить RAG-ответы в slash-команде `/rag:ask`, добавив **второй этап после semantic search**:
- **фильтрация нерелевантных результатов** по порогу similarity (MVP),
- *(опционально)* **reranker** (вторичная сортировка найденных чанков более точной моделью).

Также нужен **встроенный режим сравнения** качества: *без фильтра* vs *с фильтром* (и/или с reranker), на одном и том же вопросе.

## Контекст

- В проекте уже есть MCP server `rag-server` с tool `rag_search`, который возвращает результаты с `similarity` (0..1) и печатает проценты.
- Есть slash-команда `.claude/commands/rag/ask.md` (`/rag:ask <question> [k]`).

Проблема: top‑k часто содержит шум/слабую релевантность → контекст “размывает” ответ.

## Предлагаемый подход (MVP)

1) **Stage 1: retrieval** — `rag_search(query, limit=k)` возвращает top‑k кандидатов.
2) **Stage 2: relevance filter** — отфильтровать кандидатов по `similarity >= threshold`.

Для сравнения взять нижний порог: **`threshold = 0.70` (70%)**.

## Опционально: reranker

Варианты:
1) **LLM reranker**: дать модели список кандидатов (file_path + preview) и попросить:
   - выбрать top‑n действительно релевантных,
   - отсортировать по релевантности,
   - объяснить 1–2 предложения “почему”.
2) **Внешняя модель reranker** (cross‑encoder) — если есть готовая интеграция/ключи.

MVP можно сделать только с фильтром, а reranker — как следующий этап.

## Deliverables

1. **Улучшенная slash-команда** `/rag:ask` (или новая команда рядом, если ломать поведение нельзя), которая:
   - выполняет поиск top‑k,
   - применяет фильтр по порогу,
   - формирует ответ по отфильтрованному контексту,
   - печатает результаты *без фильтра* и *с фильтром* + сравнение.

2. **Настройка порога**:
   - порог задаётся аргументом команды (предпочтительно), либо через env/config,
   - значение по умолчанию: `0.70` (70%).

3. **Демо-сценарий сравнения**:
   - минимум 3 вопроса,
   - для каждого показать: источники (с similarity), ответ без фильтра, ответ с фильтром, вывод (1–3 предложения).

## Acceptance Criteria

- [x] Команда принимает параметры: `<question> [k] [threshold]` где k=10 по умолчанию, `threshold` по умолчанию `0.70`.
- [x] Команда выводит результаты с фильтром релевантности:
  1) `RAG Search Results (>= threshold%)` — отфильтрованные источники + ответ.
  2) Указывается сколько файлов прошло фильтр.
- [x] Если после фильтрации не осталось результатов:
  - команда явно сообщает "⚠️ No results passed threshold" и предлагает снизить `threshold` (0.60 или 0.50).
  - fallback: использует top-1 результат.
- [x] Порог реально влияет на состав контекста (не только на вывод списка).
- [x] MCP tool `rag_search` поддерживает JSON формат для программного доступа к similarity scores.

## Implementation Notes

- Simplified from original plan: removed comparison block to save context window
- Default k changed from 5 to 10 for better coverage
- Single output block with filtered results only

## Приоритет: `high`

